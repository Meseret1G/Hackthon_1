<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  </head>
  <body>
    <i id="notification-bell" class="fas fa-bell" onclick="toggleNotifications()"></i>

    <div id="notification-container" style="display: none">
      <h4>Weather Alerts:</h4>
      <ul id="notification-list"></ul>
    </div>

    <div class="container">
      <h1>Weather App</h1>
      <input type="text" id="cityInput" placeholder="Enter city name..." />
      <button onclick="getWeather()">Get Weather</button>
      <button onclick="getLocationWeather()">Use My Location</button>

      <div id="weather-info"></div>
    </div>

    <h1>Air Pollution Predictor</h1>
    <input type="text" id="city" placeholder="Enter city name" />
    <button onclick="getPollutionData()">Predict</button>
    <div id="result"></div>

    <script>
      let hasUnreadNotification = false;
      async function getPollutionData() {
        const city = document.getElementById("city").value;
        if (!city) {
          alert("Please enter a city name");
          return;
        }
        try {
          const response = await fetch(`http://127.0.0.1:5000/predict?city=${encodeURIComponent(city)}`);
          const data = await response.json();
          if (data.error) {
            document.getElementById("result").innerHTML = `<p style='color:red;'>${data.error}</p>`;
          } else {
            let output = `<h2>Air Quality in ${data.city}</h2>`;
            output += `<table border='1' style='width: 100%; border-collapse: collapse;'>`;
            output += `<tr><th>Pollutant</th><th>Value</th><th>Air Quality</th></tr>`;
            Object.keys(data).forEach((key) => {
              if (key !== "city") {
                let qualityClass = getQualityClass(data[key].air_quality);
                output += `<tr><td>${key.toUpperCase()}</td><td>${parseFloat(data[key].value).toFixed(2)}</td><td class='${qualityClass}'>${
                  data[key].air_quality
                }</td></tr>`;
              }
            });
            output += `</table>`;
            document.getElementById("result").innerHTML = output;
            document.getElementById("result").style.display = "block";
          }
        } catch (error) {
          document.getElementById("result").innerHTML = `<p style='color:red;'>Error fetching air quality data.</p>`;
          console.error("Error fetching data:", error);
        }
      }

      function getQualityClass(quality) {
        switch (quality) {
          case "Good":
            return "good";
          case "Moderate":
            return "moderate";
          case "Unhealthy for Sensitive Groups":
            return "unhealthy";
          case "Unhealthy":
            return "unhealthy";
          case "Very Unhealthy":
            return "very-unhealthy";
          case "Hazardous":
            return "hazardous";
          default:
            return "";
        }
      }
      function toggleNotifications() {
        const notificationContainer = document.getElementById("notification-container");
        const bellIcon = document.getElementById("notification-bell");

        if (notificationContainer.style.display === "block") {
          notificationContainer.style.display = "none";
          bellIcon.classList.remove("active");
          hasUnreadNotification = false;
        } else {
          notificationContainer.style.display = "block";
          if (hasUnreadNotification) {
            bellIcon.classList.add("active");
          }
        }
      }

      function getWeather() {
        const city = document.getElementById("cityInput").value;
        if (!city) {
          alert("Please enter a city name!");
          return;
        }

        fetch(`/weather?city=${city}`)
          .then((response) => response.json())
          .then((data) => displayWeather(data))
          .catch((error) => console.error("Error fetching weather:", error));
      }

      function getLocationWeather() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              fetch(`/weather?lat=${latitude}&lon=${longitude}`)
                .then((response) => response.json())
                .then((data) => displayWeather(data))
                .catch((error) => console.error("Error fetching weather:", error));
            },
            (error) => {
              alert("Failed to get location. Please allow location access.");
              console.error("Geolocation error:", error);
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      function displayWeather(data) {
        const weatherInfo = document.getElementById("weather-info");

        if (data.error) {
          weatherInfo.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
        } else {
          const weather = data.weather;
          const airPollutants = data.air_quality;
          const alerts = data.alerts;

          let weatherInfoHTML = `
            <h3>Weather in ${weather.name}</h3>
            <p><strong>Temperature:</strong> ${weather.main.temp}°C</p>
            <p><strong>Humidity:</strong> ${weather.main.humidity}%</p>
            <p><strong>Pressure:</strong> ${weather.main.pressure} hPa</p>
            <p><strong>Wind Speed:</strong> ${weather.wind.speed} m/s</p>
            <p><strong>Cloudiness:</strong> ${weather.clouds.all}%</p>
            <p><strong>Visibility:</strong> ${weather.visibility / 1000} km</p>
            <p><strong>Weather Description:</strong> ${weather.weather[0].description}</p>
          `;

          let airQualityInfo = "";
          if (airPollutants) {
            const pm25 = airPollutants.pm2_5 || "N/A";
            const pm10 = airPollutants.pm10 || "N/A";
            const co = airPollutants.co || "N/A";
            const no2 = airPollutants.no2 || "N/A";
            const o3 = airPollutants.o3 || "N/A";
            const so2 = airPollutants.so2 || "N/A";

            airQualityInfo = `
              <p><strong>Air Quality:</strong></p>
              <p>PM2.5: ${pm25} µg/m³</p>
              <p>PM10: ${pm10} µg/m³</p>
              <p>CO: ${co} µg/m³</p>
              <p>NO2: ${no2} µg/m³</p>
              <p>O3: ${o3} µg/m³</p>
              <p>SO2: ${so2} µg/m³</p>
            `;
          }

          let weatherAlertInfo = "";
          if (alerts && alerts.length > 0) {
            weatherAlertInfo = `<p><strong>Weather Alerts:</strong></p><ul>`;
            alerts.forEach((alert) => {
              weatherAlertInfo += `<li>${alert}</li>`;
            });
            weatherAlertInfo += `</ul>`;
            hasUnreadNotification = true;
            const bellIcon = document.getElementById("notification-bell");
            bellIcon.classList.add("active");
          }

          let airQualityAlertInfo = "";
          if (data.air_quality_alerts && data.air_quality_alerts.length > 0) {
            airQualityAlertInfo = `<p><strong>Air Quality Alerts:</strong></p><ul>`;
            data.air_quality_alerts.forEach((alert) => {
              airQualityAlertInfo += `<li>${alert}</li>`;
            });
            airQualityAlertInfo += `</ul>`;
          }

          weatherInfo.innerHTML = weatherInfoHTML + weatherAlertInfo + airQualityAlertInfo + airQualityInfo;
        }
      }

      function startNotifications() {
        fetch("/set_notifications", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data.message);
            alert(data.message);
            setInterval(checkWeatherAlerts, 10000);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function checkWeatherAlerts() {
        fetch("/weather")
          .then((response) => response.json())
          .then((data) => {
            const alerts = data.alerts || [];

            if (alerts.length > 0) {
              const notificationList = document.getElementById("notification-list");
              notificationList.innerHTML = "";

              alerts.forEach((alert) => {
                const listItem = document.createElement("li");
                listItem.textContent = alert;
                notificationList.appendChild(listItem);
              });

              const bellIcon = document.getElementById("notification-bell");
              bellIcon.classList.add("active");
              hasUnreadNotification = true;
            }
          })
          .catch((error) => {
            console.error("Error fetching alerts:", error);
          });
      }

      startNotifications();
    </script>
  </body>
</html>
